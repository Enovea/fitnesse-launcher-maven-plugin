<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>AbstractFitNesseMojo.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">FitNesse Launcher Maven Plugin</a> &gt; <a href="index.html" class="el_package">uk.co.javahelp.maven.plugin.fitnesse.mojo</a> &gt; <span class="el_source">AbstractFitNesseMojo.java</span></div><h1>AbstractFitNesseMojo.java</h1><pre class="source lang-java linenums">package uk.co.javahelp.maven.plugin.fitnesse.mojo;

import java.io.File;
import java.io.IOException;
import java.net.MalformedURLException;
import java.net.URL;
import java.util.Collections;
import java.util.LinkedHashSet;
import java.util.List;
import java.util.Map;
import java.util.Properties;
import java.util.Set;

import org.apache.maven.artifact.Artifact;
import org.apache.maven.artifact.ArtifactUtils;
import org.apache.maven.artifact.repository.ArtifactRepository;
import org.apache.maven.artifact.resolver.ArtifactResolutionRequest;
import org.apache.maven.artifact.resolver.ArtifactResolutionResult;
import org.apache.maven.artifact.resolver.ArtifactResolver;
import org.apache.maven.execution.MavenSession;
import org.apache.maven.model.Dependency;
import org.apache.maven.model.Plugin;
import org.apache.maven.plugin.MojoExecutionException;
import org.apache.maven.plugin.MojoFailureException;
import org.apache.maven.plugin.descriptor.PluginDescriptor;
import org.apache.maven.project.MavenProject;
import org.codehaus.plexus.classworlds.realm.ClassRealm;

import uk.co.javahelp.maven.plugin.artifact.resolver.OptionalArtifactFilter;
import uk.co.javahelp.maven.plugin.fitnesse.util.FitNesseHelper;
import uk.co.javahelp.maven.plugin.fitnesse.util.Utils;

<span class="fc" id="L33">public abstract class AbstractFitNesseMojo extends org.apache.maven.plugin.AbstractMojo {</span>
    
    /**
     * Used to look up Artifacts in the remote repository.
     * 
     * @component role=&quot;org.apache.maven.artifact.resolver.ArtifactResolver&quot;
     * @readonly
     * @required
     */
    protected ArtifactResolver resolver;

    /**
     * Location of the local repository.
     *
     * @parameter property=&quot;localRepository&quot;
     * @readonly
     * @required
     */
    protected ArtifactRepository localRepository;

    /**
     * List of Remote Repositories used by the resolver
     *
     * @parameter property=&quot;project.remoteArtifactRepositories&quot;
     * @readonly
     * @required
     */
    protected List&lt;ArtifactRepository&gt; remoteArtifactRepositories;
    
    /**
     * Maven project, to be injected by Maven itself.
     * @parameter property=&quot;project&quot;
     * @readonly
     * @required
     */
    protected MavenProject project;
    
    /**
     * The Maven Session Object
     * @parameter property=&quot;session&quot;
     * @readonly
     * @required
     */
    protected MavenSession session;
    
    /**
     * @parameter property=&quot;plugin&quot;
     * @readonly
     * @required
     */
    protected PluginDescriptor pluginDescriptor;

    /**
     * @parameter property=&quot;fitnesse.port&quot; default-value=&quot;9123&quot;
     */
    protected Integer port;

    /**
     * @parameter property=&quot;fitnesse.test.resource.directory&quot; default-value=&quot;src/test/fitnesse&quot;
     */
    protected String testResourceDirectory;

    /**
     * @parameter property=&quot;fitnesse.working&quot; default-value=&quot;${project.build.directory}/fitnesse&quot;
     */
    protected String workingDir;

    /**
     * @parameter property=&quot;fitnesse.root&quot; default-value=&quot;FitNesseRoot&quot;
     */
    protected String root;

    /**
     * @parameter property=&quot;fitnesse.logDir&quot;
     */
    protected String logDir;

    /**
     * fitnesse-launcher-maven-plugin unpacks a fresh copy of FitNesse under /target;
     * Only your project specific FitNesse tests need go under src/test/fitnesse.
     * By setting 'createSymLink' to 'true', fitnesse-launcher-maven-plugin will
     * create a FitNesse SymLink directly to your test suite under src/test/fitnesse.
     * This is most useful when developing tests in 'wiki' mode,
     * as then you can directly scm commit your changes.
     * If you prefer to copy-resources from src/test/fitnesse into /target/fitnesse,
     * let 'createSymLink' be 'false'.
     * @see &lt;a href=&quot;http://fitnesse.org/FitNesse.FullReferenceGuide.UserGuide.FitNesseWiki.SymbolicLinks&quot;&gt;What are Symbolic Links&lt;/a&gt;
     * @parameter property=&quot;fitnesse.createSymLink&quot; default-value=&quot;true&quot;
     */
    protected boolean createSymLink;

    /**
     * This is where test results go.
     * 
     * @parameter property=&quot;fitnesse.results&quot; default-value=&quot;${project.build.directory}/fitnesse/results&quot;
     * @required
     */
    protected File resultsDir;

    /**
     * This is where reports go.
     * 
     * @parameter property=&quot;fitnesse.reports&quot; default-value=&quot;${project.build.directory}/fitnesse/reports&quot;
     * @required
     */
    protected File reportsDir;

    /**
     * The summary file to write integration test results to.
     * 
     * @parameter property=&quot;fitnesse.summary.file&quot; default-value=&quot;${project.build.directory}/fitnesse/results/failsafe-summary.xml&quot;
     * @required
     */
    protected File summaryFile;
    
    /**
     * @parameter property=&quot;fitnesse.launches&quot;
     */
    protected Launch[] launches;

    /**
     * @parameter property=&quot;fitnesse.suite&quot;
     */
    protected String suite;

    /**
     * @parameter property=&quot;fitnesse.test&quot;
     */
    protected String test;

    /**
     * @see &lt;a href=&quot;http://fitnesse.org/FitNesse.FullReferenceGuide.UserGuide.WritingAcceptanceTests.TestSuites.TagsAndFilters&quot;&gt;Suite Tags&lt;/a&gt;
     * @parameter property=&quot;fitnesse.suiteFilter&quot;
     */
    protected String suiteFilter;

    /**
     * @see &lt;a href=&quot;http://fitnesse.org/FitNesse.FullReferenceGuide.UserGuide.WritingAcceptanceTests.TestSuites.TagsAndFilters&quot;&gt;Suite Tags&lt;/a&gt;
     * @parameter property=&quot;fitnesse.excludeSuiteFilter&quot;
     */
    protected String excludeSuiteFilter;
    
    /**
     * @see &lt;a href=&quot;http://fitnesse.org/FitNesse.FullReferenceGuide.UserGuide.WritingAcceptanceTests.TestSuites.TagsAndFilters&quot;&gt;Suite Tags&lt;/a&gt;
     * @parameter property=&quot;fitnesse.runTestsMatchingAllTags&quot;
     */
    protected String runTestsMatchingAllTags;
    
    /**
     * @parameter property=&quot;fitnesse.useProjectDependencies&quot;
     */
    protected Set&lt;String&gt; useProjectDependencies;
    
    /**
     * @parameter property=&quot;fitnesse.failIfNoTests&quot; default-value=true
     */
    protected Boolean failIfNoTests;
    
    /**
     * Should fitnesse-launcher-maven-plugin exclude optional transitive dependencies,
     * when configured using &amp;lt;useProjectDependencies&amp;gt; ?
     * &lt;br&gt;
     * Note: This may result in duplicates or conflicts for transitive dependencies.
     * &lt;br&gt;
     * See Issue #27.
     * &lt;br&gt;
     * Defaults to true. 
     * &lt;br&gt;
     * &lt;strong&gt;@Deprecated&lt;/strong&gt;
     * @parameter property=&quot;fitnesse.excludeOptionalDependencies&quot; default-value=&quot;true&quot;
     */
<span class="fc" id="L204">    @Deprecated</span>
    protected boolean excludeOptionalDependencies = true;

    protected FitNesseHelper fitNesseHelper;
    
    protected abstract void executeInternal(Launch... executeLaunches)
        throws MojoExecutionException, MojoFailureException;

	@Override
    public void execute() throws MojoExecutionException, MojoFailureException {
<span class="fc" id="L214">    	this.fitNesseHelper = new FitNesseHelper(getLog());</span>
<span class="fc" id="L215">        exportProperties();</span>
        // Pre-1.4.0 config is senior, as this allows easy override from command line using -D
<span class="fc bfc" id="L217" title="All 4 branches covered.">        if(this.suite == null &amp;&amp; this.test == null) {</span>
        	// if this.launches.length == 0, it won't throw exception, just nothing to run 
<span class="fc" id="L219">            executeInternal(this.launches);</span>
        } else {
<span class="fc" id="L221">            executeInternal(new Launch(this.suite, this.test, this.suiteFilter, this.excludeSuiteFilter, this.runTestsMatchingAllTags));</span>
        }
<span class="fc" id="L223">    }</span>

    private static final String LOG_LINE = &quot;------------------------------------------------------------------------&quot;;
        
    protected final void exportProperties() {
<span class="fc" id="L228">        final Properties projectProperties = this.project.getProperties();</span>
<span class="fc" id="L229">        getLog().info(LOG_LINE);</span>
<span class="fc" id="L230">        final String mavenClasspath = calcWikiFormatClasspath();</span>
<span class="fc" id="L231">        setSystemProperty(&quot;maven.classpath&quot;, mavenClasspath);</span>

        // If a System property already exists, it has priority;
        // That way we can override with a -D on the command line
<span class="fc bfc" id="L235" title="All 2 branches covered.">        for(String key : projectProperties.stringPropertyNames()) {</span>
<span class="fc" id="L236">            final String value = this.session.getSystemProperties()</span>
                .getProperty(key, projectProperties.getProperty(key));
<span class="fc" id="L238">            setSystemProperty(key, value);</span>
<span class="fc" id="L239">        }</span>
<span class="fc" id="L240">        setSystemProperty(&quot;artifact&quot;, this.project.getArtifactId());</span>
<span class="fc" id="L241">        setSystemProperty(&quot;version&quot;, this.project.getVersion());</span>
        try {
<span class="fc" id="L243">            final String basedir = this.project.getBasedir().getCanonicalPath();</span>
<span class="fc" id="L244">            setSystemProperty(&quot;basedir&quot;, basedir);</span>
<span class="fc" id="L245">        } catch (Exception e) {</span>
<span class="fc" id="L246">        	getLog().error(e);</span>
<span class="fc" id="L247">        }</span>
<span class="fc" id="L248">        getLog().info(LOG_LINE);</span>
<span class="fc" id="L249">    }</span>

    protected final void setSystemProperty(final String key, final String value) {
<span class="fc bfc" id="L252" title="All 4 branches covered.">        if(!Utils.isBlank(key) &amp;&amp; !Utils.isBlank(value)) {</span>
<span class="fc" id="L253">            getLog().info(String.format(&quot;Setting FitNesse variable [%s] to [%s]&quot;, key, value));</span>
<span class="fc" id="L254">            System.setProperty(key, value);</span>
        }
<span class="fc" id="L256">    }</span>

    protected final String calcWikiFormatClasspath() {
<span class="fc" id="L259">        final Set&lt;Artifact&gt; artifacts = buildArtifactSet();</span>
<span class="fc" id="L260">        return addArtifactsToClasspath(artifacts);</span>
    }

	private Set&lt;Artifact&gt; buildArtifactSet() {
<span class="fc" id="L264">        final Set&lt;Artifact&gt; artifacts = new LinkedHashSet&lt;Artifact&gt;();</span>
<span class="fc" id="L265">        addPluginArtifacts(artifacts);</span>
<span class="fc" id="L266">        addProjectArtifacts(artifacts);</span>
<span class="fc" id="L267">       	return artifacts;</span>
    }

	private void addPluginArtifacts(final Set&lt;Artifact&gt; artifacts) {
<span class="fc" id="L271">   		final Map&lt;String, Artifact&gt; dependencyArtifactMap = this.pluginDescriptor.getArtifactMap(); </span>
        // We should always have FitNesse itself on the FitNesse classpath!
<span class="fc" id="L273">       	artifacts.addAll(resolveDependencyKey(FitNesse.artifactKey, dependencyArtifactMap));</span>
                
       	// We check plugin for null to allow use in standalone mode
<span class="fc" id="L276">        final Plugin fitnessePlugin = this.project.getPlugin(this.pluginDescriptor.getPluginLookupKey());</span>
<span class="fc bfc" id="L277" title="All 2 branches covered.">       	if(fitnessePlugin == null) {</span>
<span class="fc" id="L278">            getLog().info(&quot;Running standalone - launching vanilla FitNesse&quot;);</span>
       	} else {
<span class="fc" id="L280">            final List&lt;Dependency&gt; dependecies = fitnessePlugin.getDependencies();</span>
<span class="pc bpc" id="L281" title="1 of 4 branches missed.">            if(dependecies != null &amp;&amp; !dependecies.isEmpty()) {</span>
<span class="fc" id="L282">                getLog().info(&quot;Using dependencies specified in plugin config&quot;);</span>
<span class="fc bfc" id="L283" title="All 2 branches covered.">        	    for(Dependency dependency : dependecies) {</span>
<span class="fc" id="L284">        			final String key = dependency.getGroupId() + &quot;:&quot; + dependency.getArtifactId();</span>
<span class="fc" id="L285">        			artifacts.addAll(resolveDependencyKey(key, dependencyArtifactMap));</span>
<span class="fc" id="L286">        		}</span>
        	}
        }
<span class="fc" id="L289">    }</span>

    /**
     * From {@link org.apache.maven.project.MavenProject#getArtifacts()}:
     * All dependencies that this project has, including transitive ones.
     * Contents are lazily populated, so depending on what phases have run
     * dependencies in some scopes won't be included. eg. if only compile
     * phase has run, dependencies with scope test won't be included.
     * @see org.apache.maven.project.MavenProject#getArtifacts()
     * See &lt;a href=&quot;http://maven.apache.org/developers/mojo-api-specification.html#The_Descriptor_and_Annotations&quot;&gt;requiresDependencyResolution&lt;/a&gt;
     */
	private void addProjectArtifacts(final Set&lt;Artifact&gt; artifacts) {
<span class="fc bfc" id="L301" title="All 2 branches covered.">       	if(!this.useProjectDependencies.isEmpty()) {</span>
<span class="fc" id="L302">            getLog().info(&quot;Using dependencies in the following scopes: &quot; + this.useProjectDependencies);</span>
<span class="fc bfc" id="L303" title="All 2 branches covered.">            if(!this.excludeOptionalDependencies) {</span>
<span class="fc" id="L304">            	getLog().info(&quot;Including transitive dependencies which are optional&quot;);</span>
<span class="fc" id="L305">                resolveProjectDependencies(artifacts);</span>
        	} else {
<span class="fc bfc" id="L307" title="All 2 branches covered.">		        for(Artifact artifact : this.project.getArtifacts()) {</span>
<span class="fc bfc" id="L308" title="All 2 branches covered.">   	    			if(this.useProjectDependencies.contains(artifact.getScope())) {</span>
<span class="fc" id="L309">       					artifacts.add(artifact);</span>
       				}
<span class="fc" id="L311">   				}</span>
        	}
       	}
<span class="fc" id="L314">    }</span>

	private String addArtifactsToClasspath(final Set&lt;Artifact&gt; artifacts) {
<span class="fc" id="L317">        final StringBuilder wikiFormatClasspath = new StringBuilder(&quot;\n&quot;);</span>
<span class="fc" id="L318">		final ClassRealm realm = this.pluginDescriptor.getClassRealm();</span>
<span class="fc" id="L319">	    setupLocalTestClasspath(realm, wikiFormatClasspath);</span>
<span class="fc bfc" id="L320" title="All 2 branches covered.">        for (Artifact artifact : artifacts) {</span>
<span class="fc" id="L321">		    final File artifactFile = artifact.getFile();</span>
<span class="fc bfc" id="L322" title="All 2 branches covered.">            if(artifactFile != null) {</span>
<span class="fc" id="L323">                getLog().debug(String.format(&quot;Adding artifact to FitNesse classpath [%s]&quot;, artifact));</span>
<span class="fc" id="L324">				this.fitNesseHelper.formatAndAppendClasspathArtifact(wikiFormatClasspath, artifact);</span>
<span class="fc" id="L325">    	        addToRealm(realm, artifactFile);</span>
            } else {
<span class="fc" id="L327">                getLog().warn(String.format(&quot;File for artifact [%s] is not found&quot;, artifact));</span>
            }
<span class="fc" id="L329">        }</span>
<span class="fc" id="L330">        return wikiFormatClasspath.toString();</span>
    }

    /**
     * See Issue #27. This method may result in duplicates or conflicts for transitive dependencies.
     * Better to use correct @requiresDependencyResolution for mojo, in combination with project.getArtifacts().
     * See &lt;a href=&quot;http://maven.apache.org/developers/mojo-api-specification.html#The_Descriptor_and_Annotations&quot;&gt;requiresDependencyResolution&lt;/a&gt;
     */
    @Deprecated
	private void resolveProjectDependencies(final Set&lt;Artifact&gt; artifacts) {
<span class="fc" id="L340">		final Map&lt;String, Artifact&gt; dependencyArtifactMap = ArtifactUtils.artifactMapByVersionlessId(this.project.getDependencyArtifacts());</span>
<span class="fc" id="L341">       	final List&lt;Dependency&gt; dependecies = this.project.getDependencies();</span>
<span class="fc bfc" id="L342" title="All 2 branches covered.">		for(Dependency dependency : dependecies) {</span>
<span class="fc" id="L343">	    	final String key = dependency.getGroupId() + &quot;:&quot; + dependency.getArtifactId();</span>
<span class="fc bfc" id="L344" title="All 2 branches covered.">   	    	if(this.useProjectDependencies.contains(dependency.getScope())) {</span>
<span class="fc" id="L345">       			artifacts.addAll(resolveDependencyKey(key, dependencyArtifactMap));</span>
       		}
<span class="fc" id="L347">   		}</span>
<span class="fc" id="L348">    }</span>

	private void setupLocalTestClasspath(final ClassRealm realm, final StringBuilder wikiFormatClasspath) {
<span class="fc" id="L351">		setupLocalTestClasspath(realm, wikiFormatClasspath, handleWhitespace(this.project.getBuild().getTestOutputDirectory()));</span>
<span class="fc" id="L352">		setupLocalTestClasspath(realm, wikiFormatClasspath, handleWhitespace(this.project.getBuild().getOutputDirectory()));</span>
<span class="fc" id="L353">    }</span>
	
	private String handleWhitespace(final String directory) {
<span class="fc bfc" id="L356" title="All 2 branches covered.">		if(Utils.whitespaceSituation(directory)) {</span>
            try {
<span class="fc" id="L358">        		final String relativePath = Utils.getRelativePath(new File(&quot;.&quot;), new File(directory));</span>
<span class="fc bfc" id="L359" title="All 2 branches covered.">        		if(!Utils.whitespaceSituation(relativePath)) {</span>
<span class="fc" id="L360">            		getLog().warn(Utils.whitespaceWarning(directory, &quot;Attempting relative path workaround&quot;));</span>
<span class="fc" id="L361">            		return relativePath;</span>
        		}
<span class="nc" id="L363">			} catch (final IOException e) {</span>
<span class="nc" id="L364">            	getLog().error(e);</span>
<span class="fc" id="L365">			}</span>
		}
<span class="fc" id="L367">		return directory;</span>
	}

	private void setupLocalTestClasspath(final ClassRealm realm,
			final StringBuilder wikiFormatClasspath,
			final String testClasspathElement) {

<span class="fc" id="L374">        getLog().debug(String.format(&quot;Adding element to FitNesse classpath [%s]&quot;, testClasspathElement));</span>
<span class="fc" id="L375">		this.fitNesseHelper.formatAndAppendClasspath(wikiFormatClasspath, testClasspathElement);</span>
<span class="fc" id="L376">        addToRealm(realm,  new File(testClasspathElement));</span>
<span class="fc" id="L377">	}</span>
	
	private void addToRealm(final ClassRealm realm, final File file) {
	    try {
<span class="fc" id="L381">			final URL url = file.toURI().toURL();</span>
<span class="fc" id="L382">            getLog().debug(String.format(&quot;Adding URL to ClassRealm [%s]&quot;, url));</span>
<span class="fc" id="L383">			realm.addURL(url);</span>
<span class="nc" id="L384">		} catch (final MalformedURLException e) {</span>
<span class="nc" id="L385">            getLog().error(e);</span>
<span class="fc" id="L386">		}</span>
<span class="fc" id="L387">	}</span>

    private Set&lt;Artifact&gt; resolveDependencyKey(final String key, final Map&lt;String, Artifact&gt; artifactMap) {
<span class="fc" id="L390">       	final Artifact artifact = artifactMap.get(key);</span>
<span class="fc bfc" id="L391" title="All 2 branches covered.">       	if(artifact == null) {</span>
<span class="fc" id="L392">            getLog().error(String.format(&quot;Lookup for artifact [%s] failed&quot;, key));</span>
<span class="fc" id="L393">            return Collections.emptySet();</span>
       	}
<span class="fc" id="L395">        return resolveArtifactTransitively(artifact);</span>
    }

    private Set&lt;Artifact&gt; resolveArtifactTransitively(final Artifact artifact) {
<span class="fc" id="L399">        final ArtifactResolutionRequest request = new ArtifactResolutionRequest()</span>
            .setArtifact( artifact )
			.setResolveRoot( true )
			.setResolveTransitively( true )
			.setRemoteRepositories( this.remoteArtifactRepositories )
			.setLocalRepository( this.localRepository );
<span class="fc bfc" id="L405" title="All 2 branches covered.">        if(this.excludeOptionalDependencies) {</span>
<span class="fc" id="L406">			request.setCollectionFilter(OptionalArtifactFilter.INSTANCE);</span>
        }
<span class="fc" id="L408">		final ArtifactResolutionResult result = this.resolver.resolve(request);</span>
<span class="fc bfc" id="L409" title="All 2 branches covered.">        if(!result.isSuccess()) {</span>
<span class="fc bfc" id="L410" title="All 2 branches covered.">            for(Artifact missing : result.getMissingArtifacts()) {</span>
<span class="fc" id="L411">    			getLog().error(String.format(&quot;Could not resolve artifact: [%s]&quot;, missing));</span>
<span class="fc" id="L412">        	}</span>
<span class="pc bpc" id="L413" title="1 of 4 branches missed.">        	if(result.hasExceptions() &amp;&amp; getLog().isDebugEnabled()) {</span>
<span class="fc bfc" id="L414" title="All 2 branches covered.">            	for(Exception exception : result.getExceptions()) {</span>
<span class="fc" id="L415">    		    	getLog().debug(exception);</span>
<span class="fc" id="L416">            	}</span>
        	}
        }
<span class="fc" id="L419">   		final Set&lt;Artifact&gt; dependencies = result.getArtifacts();</span>
<span class="fc" id="L420">		return dependencies;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.0.201210061924</span></div></body></html>
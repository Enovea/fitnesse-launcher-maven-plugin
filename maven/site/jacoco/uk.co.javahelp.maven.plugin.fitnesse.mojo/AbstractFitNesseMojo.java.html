<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>AbstractFitNesseMojo.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">FitNesse Launcher Plugin</a> &gt; <a href="index.html" class="el_package">uk.co.javahelp.maven.plugin.fitnesse.mojo</a> &gt; <span class="el_source">AbstractFitNesseMojo.java</span></div><h1>AbstractFitNesseMojo.java</h1><pre class="source lang-java linenums">package uk.co.javahelp.maven.plugin.fitnesse.mojo;

import java.io.File;
import java.io.IOException;
import java.util.Collections;
import java.util.HashSet;
import java.util.List;
import java.util.Properties;
import java.util.Set;

import org.apache.maven.artifact.Artifact;
import org.apache.maven.artifact.repository.ArtifactRepository;
import org.apache.maven.artifact.resolver.ArtifactResolutionRequest;
import org.apache.maven.artifact.resolver.ArtifactResolutionResult;
import org.apache.maven.artifact.resolver.ArtifactResolver;
import org.apache.maven.execution.MavenSession;
import org.apache.maven.model.Dependency;
import org.apache.maven.plugin.BuildPluginManager;
import org.apache.maven.plugin.MojoExecutionException;
import org.apache.maven.plugin.MojoFailureException;
import org.apache.maven.plugin.descriptor.PluginDescriptor;
import org.apache.maven.project.MavenProject;

import uk.co.javahelp.maven.plugin.fitnesse.util.FitNesseHelper;

<span class="fc" id="L26">public abstract class AbstractFitNesseMojo extends org.apache.maven.plugin.AbstractMojo {</span>

    /**
     * The Maven Session Object
     *
     * @parameter expression=&quot;${session}&quot;
     * @required
     * @readonly
     */
    protected MavenSession session;

    /**
     * The Maven BuildPluginManager Object
     *
     * @component
     * @required
     */
    protected BuildPluginManager pluginManager;
    
    /**
     * Used to look up Artifacts in the remote repository.
     * 
     * @component role=&quot;org.apache.maven.artifact.resolver.ArtifactResolver&quot;
     * @required
     * @readonly
     */
    protected ArtifactResolver resolver;

    /**
     * Location of the local repository.
     *
     * @parameter expression=&quot;${localRepository}&quot;
     * @readonly
     * @required
     */
    protected ArtifactRepository localRepository;

    /**
     * List of Remote Repositories used by the resolver
     *
     * @parameter expression=&quot;${project.remoteArtifactRepositories}&quot;
     * @readonly
     * @required
     */
    protected List&lt;ArtifactRepository&gt; remoteArtifactRepositories;
    
    /**
     * Maven project, to be injected by Maven itself.
     * @parameter expression=&quot;${project}&quot;
     * @required
     */
    protected MavenProject project;
    
    /**
     * @parameter expression=&quot;${plugin}&quot;
     * @required
     */
    protected PluginDescriptor pluginDescriptor;

    /**
     * @parameter expression=&quot;${fitnesse.port}&quot; default-value=&quot;9123&quot;
     */
    protected Integer port;

    /**
     * @parameter expression=&quot;${fitnesse.test.resource.directory}&quot; default-value=&quot;src/test/fitnesse&quot;
     */
    protected String testResourceDirectory;

    /**
     * @parameter expression=&quot;${fitnesse.working}&quot; default-value=&quot;${project.build.directory}/fitnesse&quot;
     */
    protected String workingDir;

    /**
     * @parameter expression=&quot;${fitnesse.root}&quot; default-value=&quot;FitNesseRoot&quot;
     */
    protected String root;

    /**
     * @parameter expression=&quot;${fitnesse.logDir}&quot;
     */
    protected String logDir;

    /**
     * fitnesse-launcher-maven-plugin unpacks a fresh copy of FitNesse under /target;
     * Only your project specific FitNesse tests need go under src/test/fitnesse.
     * By setting 'createSymLink' to 'true', fitnesse-launcher-maven-plugin will
     * create a FitNesse SymLink directly to your test suite under src/test/fitnesse.
     * This is most useful when developing tests in 'wiki' mode,
     * as then you can directly scm commit your changes.
     * If you prefer to copy-resources from src/test/fitnesse into /target/fitnesse,
     * let 'createSymLink' be 'false'.
     * @see &lt;a href=&quot;http://fitnesse.org/FitNesse.UserGuide.SymbolicLinks&quot;&gt;FitNesse SymLink User Guide&lt;/a&gt;
     * @parameter expression=&quot;${fitnesse.createSymLink}&quot;
     */
    protected boolean createSymLink;

    /**
     * The summary file to write integration test results to.
     * 
     * @parameter expression=&quot;${fitnesse.working}/results/failsafe-summary.xml&quot;
     * @required
     */
    protected File summaryFile;

    /**
     * This is where build results go.
     * 
     * @parameter default-value=&quot;${fitnesse.working}/results&quot;
     * @required
     */
    protected File resultsDir;

    /**
     * This is where build results go.
     * 
     * @parameter default-value=&quot;${fitnesse.working}/reports&quot;
     * @required
     */
    protected File reportsDir;

    /**
     * @parameter expression=&quot;${fitnesse.suite}&quot;
     */
    protected String suite;

    /**
     * @parameter expression=&quot;${fitnesse.test}&quot;
     */
    protected String test;

    /**
     * @parameter expression=&quot;${fitnesse.suiteFilter}&quot;
     */
    protected String suiteFilter;

    /**
     * @parameter expression=&quot;${fitnesse.excludeSuiteFilter}&quot;
     */
    protected String excludeSuiteFilter;
    
    protected FitNesseHelper fitNesseHelper;

    protected abstract void executeInternal() throws MojoExecutionException, MojoFailureException;

	@Override
    public void execute() throws MojoExecutionException, MojoFailureException {
<span class="nc" id="L174">    	this.fitNesseHelper = new FitNesseHelper(getLog());</span>
<span class="nc" id="L175">        exportProperties();</span>
<span class="nc" id="L176">        executeInternal();</span>
<span class="nc" id="L177">    }</span>

    private static final String LOG_LINE = &quot;------------------------------------------------------------------------&quot;;
        
    protected void exportProperties() {
<span class="fc" id="L182">        final Properties projectProperties = this.project.getProperties();</span>
<span class="fc" id="L183">        getLog().info(LOG_LINE);</span>
<span class="fc" id="L184">        final String mavenClasspath = calcWikiFormatClasspath();</span>
<span class="fc" id="L185">        setSystemProperty(&quot;maven.classpath&quot;, mavenClasspath);</span>

        // If a System property already exists, it has priority;
        // That way we can override with a -D on the command line
<span class="fc bfc" id="L189" title="All 2 branches covered.">        for(String key : projectProperties.stringPropertyNames()) {</span>
<span class="fc" id="L190">            final String value = System.getProperty(key, projectProperties.getProperty(key));</span>
<span class="fc" id="L191">            setSystemProperty(key, value);</span>
<span class="fc" id="L192">        }</span>
<span class="fc" id="L193">        setSystemProperty(&quot;artifact&quot;, this.project.getArtifactId());</span>
<span class="fc" id="L194">        setSystemProperty(&quot;version&quot;, this.project.getVersion());</span>
        try {
<span class="fc" id="L196">            final String basedir = this.project.getBasedir().getCanonicalPath();</span>
<span class="fc" id="L197">            setSystemProperty(&quot;basedir&quot;, basedir);</span>
<span class="nc" id="L198">        } catch (IOException e) {</span>
<span class="nc" id="L199">        	getLog().error(e);</span>
<span class="fc" id="L200">        }</span>
<span class="fc" id="L201">        getLog().info(LOG_LINE);</span>
<span class="fc" id="L202">    }</span>

    protected void setSystemProperty(final String key, final String value) {
<span class="pc bpc" id="L205" title="4 of 8 branches missed.">        if(key != null &amp;&amp; value != null &amp;&amp;</span>
                !key.trim().equals(&quot;&quot;) &amp;&amp;
                !value.trim().equals(&quot;&quot;)) {
<span class="fc" id="L208">            getLog().info(String.format(&quot;Setting FitNesse variable [%s] to [%s]&quot;, key, value));</span>
<span class="fc" id="L209">            System.setProperty(key, value);</span>
        }
<span class="fc" id="L211">    }</span>

    protected String calcWikiFormatClasspath() {
<span class="fc" id="L214">        final Set&lt;Artifact&gt; artifacts = new HashSet&lt;Artifact&gt;();</span>
        
        // We should always have FitNesse itself on the FitNesse classpath!
<span class="fc" id="L217">       	artifacts.addAll(resolveDependencyKey(FitNesse.artifactKey));</span>
                
<span class="fc" id="L219">        final List&lt;Dependency&gt; dependecies = </span>
            this.project.getPlugin(this.pluginDescriptor.getPluginLookupKey()).getDependencies();
        
<span class="fc bfc" id="L222" title="All 2 branches covered.">        for(Dependency dependency : dependecies) {</span>
<span class="fc" id="L223">        	final String key = dependency.getGroupId() + &quot;:&quot; + dependency.getArtifactId();</span>
<span class="fc" id="L224">        	artifacts.addAll(resolveDependencyKey(key));</span>
<span class="fc" id="L225">        }</span>
<span class="fc" id="L226">        final StringBuilder wikiFormatClasspath = new StringBuilder(&quot;\n&quot;);</span>
<span class="fc bfc" id="L227" title="All 2 branches covered.">        for (Artifact artifact : artifacts) {</span>
<span class="fc bfc" id="L228" title="All 2 branches covered.">            if(artifact.getFile() != null) {</span>
<span class="fc" id="L229">                getLog().debug(String.format(&quot;Adding artifact to FitNesse classpath [%s]&quot;, artifact));</span>
<span class="fc" id="L230">                this.fitNesseHelper.formatAndAppendClasspathArtifact(wikiFormatClasspath, artifact);</span>
            } else {
<span class="fc" id="L232">                getLog().warn(String.format(&quot;File for artifact [%s] is not found&quot;, artifact));</span>
            }
<span class="fc" id="L234">        }</span>
<span class="fc" id="L235">        return wikiFormatClasspath.toString();</span>
    }

    private Set&lt;Artifact&gt; resolveDependencyKey(final String key) {
<span class="fc" id="L239">       	final Artifact artifact = this.pluginDescriptor.getArtifactMap().get(key);</span>
<span class="fc bfc" id="L240" title="All 2 branches covered.">       	if(artifact == null) {</span>
<span class="fc" id="L241">            getLog().warn(String.format(&quot;Lookup for artifact [%s] failed&quot;, key));</span>
<span class="fc" id="L242">            return Collections.emptySet();</span>
       	}
<span class="fc" id="L244">        return resolveArtifactTransitively(artifact);</span>
    }

    private Set&lt;Artifact&gt; resolveArtifactTransitively(final Artifact artifact) {
<span class="fc" id="L248">        final ArtifactResolutionRequest request = new ArtifactResolutionRequest()</span>
            .setArtifact( artifact )
			.setResolveRoot( true )
			.setResolveTransitively( true )
			.setRemoteRepositories( this.remoteArtifactRepositories )
			.setLocalRepository( this.localRepository );
<span class="fc" id="L254">		final ArtifactResolutionResult result = this.resolver.resolve(request);</span>
<span class="fc bfc" id="L255" title="All 2 branches covered.">        if(!result.isSuccess()) {</span>
<span class="fc bfc" id="L256" title="All 2 branches covered.">            for(Artifact missing : result.getMissingArtifacts()) {</span>
<span class="fc" id="L257">    			getLog().warn(String.format(&quot;Could not resolve artifact: [%s]&quot;, missing));</span>
<span class="fc" id="L258">        	}</span>
<span class="pc bpc" id="L259" title="1 of 4 branches missed.">        	if(result.hasExceptions() &amp;&amp; getLog().isDebugEnabled()) {</span>
<span class="fc bfc" id="L260" title="All 2 branches covered.">            	for(Exception exception : result.getExceptions()) {</span>
<span class="fc" id="L261">    		    	getLog().debug(exception);</span>
<span class="fc" id="L262">            	}</span>
        	}
        }
<span class="fc" id="L265">   		final Set&lt;Artifact&gt; dependencies = result.getArtifacts();</span>
<span class="fc" id="L266">		return dependencies;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.0.201210061924</span></div></body></html>
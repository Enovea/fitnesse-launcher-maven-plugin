<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>AbstractFitNesseMojo.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">FitNesse Launcher Plugin</a> &gt; <a href="index.html" class="el_package">uk.co.javahelp.maven.plugin.fitnesse.mojo</a> &gt; <span class="el_source">AbstractFitNesseMojo.java</span></div><h1>AbstractFitNesseMojo.java</h1><pre class="source lang-java linenums">package uk.co.javahelp.maven.plugin.fitnesse.mojo;

import static uk.co.javahelp.maven.plugin.fitnesse.util.FitNesseHelper.isBlank;

import java.io.File;
import java.io.IOException;
import java.util.Collections;
import java.util.HashSet;
import java.util.List;
import java.util.Properties;
import java.util.Set;

import org.apache.maven.artifact.Artifact;
import org.apache.maven.artifact.repository.ArtifactRepository;
import org.apache.maven.artifact.resolver.ArtifactResolutionRequest;
import org.apache.maven.artifact.resolver.ArtifactResolutionResult;
import org.apache.maven.artifact.resolver.ArtifactResolver;
import org.apache.maven.execution.MavenSession;
import org.apache.maven.model.Dependency;
import org.apache.maven.model.Plugin;
import org.apache.maven.plugin.BuildPluginManager;
import org.apache.maven.plugin.MojoExecutionException;
import org.apache.maven.plugin.MojoFailureException;
import org.apache.maven.plugin.descriptor.PluginDescriptor;
import org.apache.maven.project.MavenProject;
import org.codehaus.plexus.classworlds.realm.ClassRealm;

import uk.co.javahelp.maven.plugin.fitnesse.util.FitNesseHelper;

<span class="fc" id="L30">public abstract class AbstractFitNesseMojo extends org.apache.maven.plugin.AbstractMojo {</span>

    /**
     * The Maven Session Object
     *
     * @parameter property=&quot;session&quot;
     * @readonly
     * @required
     */
    protected MavenSession session;

    /**
     * The Maven BuildPluginManager Object
     *
     * @component
     * @readonly
     * @required
     */
    protected BuildPluginManager pluginManager;
    
    /**
     * Used to look up Artifacts in the remote repository.
     * 
     * @component role=&quot;org.apache.maven.artifact.resolver.ArtifactResolver&quot;
     * @readonly
     * @required
     */
    protected ArtifactResolver resolver;

    /**
     * Location of the local repository.
     *
     * @parameter property=&quot;localRepository&quot;
     * @readonly
     * @required
     */
    protected ArtifactRepository localRepository;

    /**
     * List of Remote Repositories used by the resolver
     *
     * @parameter property=&quot;project.remoteArtifactRepositories&quot;
     * @readonly
     * @required
     */
    protected List&lt;ArtifactRepository&gt; remoteArtifactRepositories;
    
    /**
     * Maven project, to be injected by Maven itself.
     * @parameter property=&quot;project&quot;
     * @readonly
     * @required
     */
    protected MavenProject project;
    
    /**
     * @parameter property=&quot;plugin&quot;
     * @readonly
     * @required
     */
    protected PluginDescriptor pluginDescriptor;

    /**
     * @parameter property=&quot;fitnesse.port&quot; default-value=&quot;9123&quot;
     */
    protected Integer port;

    /**
     * @parameter property=&quot;fitnesse.test.resource.directory&quot; default-value=&quot;src/test/fitnesse&quot;
     */
    protected String testResourceDirectory;

    /**
     * @parameter property=&quot;fitnesse.working&quot; default-value=&quot;${project.build.directory}/fitnesse&quot;
     */
    protected String workingDir;

    /**
     * @parameter property=&quot;fitnesse.root&quot; default-value=&quot;FitNesseRoot&quot;
     */
    protected String root;

    /**
     * @parameter property=&quot;fitnesse.logDir&quot;
     */
    protected String logDir;

    /**
     * fitnesse-launcher-maven-plugin unpacks a fresh copy of FitNesse under /target;
     * Only your project specific FitNesse tests need go under src/test/fitnesse.
     * By setting 'createSymLink' to 'true', fitnesse-launcher-maven-plugin will
     * create a FitNesse SymLink directly to your test suite under src/test/fitnesse.
     * This is most useful when developing tests in 'wiki' mode,
     * as then you can directly scm commit your changes.
     * If you prefer to copy-resources from src/test/fitnesse into /target/fitnesse,
     * let 'createSymLink' be 'false'.
     * @see &lt;a href=&quot;http://fitnesse.org/FitNesse.UserGuide.SymbolicLinks&quot;&gt;FitNesse SymLink User Guide&lt;/a&gt;
     * @parameter property=&quot;fitnesse.createSymLink&quot;
     */
    protected boolean createSymLink;

    /**
     * This is where build results go.
     * 
     * @parameter default-value=&quot;${fitnesse.working}/results&quot;
     * @required
     */
    protected File resultsDir;

    /**
     * This is where build results go.
     * 
     * @parameter default-value=&quot;${fitnesse.working}/reports&quot;
     * @required
     */
    protected File reportsDir;

    /**
     * The summary file to write integration test results to.
     * 
     * @parameter default-value=&quot;${fitnesse.working}/results/failsafe-summary.xml&quot;
     * @required
     */
    protected File summaryFile;

    /**
     * @parameter property=&quot;fitnesse.suite&quot;
     */
    protected String suite;

    /**
     * @parameter property=&quot;fitnesse.test&quot;
     */
    protected String test;

    /**
     * @parameter property=&quot;fitnesse.suiteFilter&quot;
     */
    protected String suiteFilter;

    /**
     * @parameter property=&quot;fitnesse.excludeSuiteFilter&quot;
     */
    protected String excludeSuiteFilter;
    
    protected FitNesseHelper fitNesseHelper;

    protected abstract void executeInternal() throws MojoExecutionException, MojoFailureException;

	@Override
    public void execute() throws MojoExecutionException, MojoFailureException {
<span class="fc" id="L181">    	this.fitNesseHelper = new FitNesseHelper(getLog());</span>
<span class="fc" id="L182">        exportProperties();</span>
<span class="fc" id="L183">        executeInternal();</span>
<span class="fc" id="L184">    }</span>

    private static final String LOG_LINE = &quot;------------------------------------------------------------------------&quot;;
        
    protected void exportProperties() throws MojoExecutionException {
<span class="fc" id="L189">        final Properties projectProperties = this.project.getProperties();</span>
<span class="fc" id="L190">        getLog().info(LOG_LINE);</span>
<span class="fc" id="L191">        final String mavenClasspath = calcWikiFormatClasspath();</span>
<span class="fc" id="L192">        setSystemProperty(&quot;maven.classpath&quot;, mavenClasspath);</span>

        // If a System property already exists, it has priority;
        // That way we can override with a -D on the command line
<span class="fc bfc" id="L196" title="All 2 branches covered.">        for(String key : projectProperties.stringPropertyNames()) {</span>
<span class="fc" id="L197">            final String value = System.getProperty(key, projectProperties.getProperty(key));</span>
<span class="fc" id="L198">            setSystemProperty(key, value);</span>
<span class="fc" id="L199">        }</span>
<span class="fc" id="L200">        setSystemProperty(&quot;artifact&quot;, this.project.getArtifactId());</span>
<span class="fc" id="L201">        setSystemProperty(&quot;version&quot;, this.project.getVersion());</span>
        try {
<span class="fc" id="L203">            final String basedir = this.project.getBasedir().getCanonicalPath();</span>
<span class="fc" id="L204">            setSystemProperty(&quot;basedir&quot;, basedir);</span>
<span class="nc" id="L205">        } catch (IOException e) {</span>
<span class="nc" id="L206">        	getLog().error(e);</span>
<span class="fc" id="L207">        }</span>
<span class="fc" id="L208">        getLog().info(LOG_LINE);</span>
<span class="fc" id="L209">    }</span>

    protected void setSystemProperty(final String key, final String value) {
<span class="fc bfc" id="L212" title="All 4 branches covered.">        if(!isBlank(key) &amp;&amp; !isBlank(value)) {</span>
<span class="fc" id="L213">            getLog().info(String.format(&quot;Setting FitNesse variable [%s] to [%s]&quot;, key, value));</span>
<span class="fc" id="L214">            System.setProperty(key, value);</span>
        }
<span class="fc" id="L216">    }</span>

    protected String calcWikiFormatClasspath() throws MojoExecutionException {
<span class="fc" id="L219">        final Set&lt;Artifact&gt; artifacts = new HashSet&lt;Artifact&gt;();</span>
        
        // We should always have FitNesse itself on the FitNesse classpath!
<span class="fc" id="L222">       	artifacts.addAll(resolveDependencyKey(FitNesse.artifactKey));</span>
                
       	// We check plugin for null to allow use in standalone mode
<span class="fc" id="L225">        final Plugin fitnessePlugin = this.project.getPlugin(this.pluginDescriptor.getPluginLookupKey());</span>
<span class="fc bfc" id="L226" title="All 2 branches covered.">       	if(fitnessePlugin == null) {</span>
<span class="fc" id="L227">            getLog().info(&quot;Running standalone - launching vanilla FitNesse&quot;);</span>
       	} else {
<span class="fc" id="L229">            final List&lt;Dependency&gt; dependecies = fitnessePlugin.getDependencies();</span>
<span class="fc bfc" id="L230" title="All 2 branches covered.">        	for(Dependency dependency : dependecies) {</span>
<span class="fc" id="L231">        		final String key = dependency.getGroupId() + &quot;:&quot; + dependency.getArtifactId();</span>
<span class="fc" id="L232">        		artifacts.addAll(resolveDependencyKey(key));</span>
<span class="fc" id="L233">        	}</span>
        }
       	
<span class="fc" id="L236">        final StringBuilder wikiFormatClasspath = new StringBuilder(&quot;\n&quot;);</span>
<span class="fc" id="L237">	    setupLocalTestClasspath(wikiFormatClasspath);</span>
<span class="fc bfc" id="L238" title="All 2 branches covered.">        for (Artifact artifact : artifacts) {</span>
<span class="fc bfc" id="L239" title="All 2 branches covered.">            if(artifact.getFile() != null) {</span>
<span class="fc" id="L240">                getLog().debug(String.format(&quot;Adding artifact to FitNesse classpath [%s]&quot;, artifact));</span>
<span class="fc" id="L241">                this.fitNesseHelper.formatAndAppendClasspathArtifact(wikiFormatClasspath, artifact);</span>
            } else {
<span class="fc" id="L243">                getLog().warn(String.format(&quot;File for artifact [%s] is not found&quot;, artifact));</span>
            }
<span class="fc" id="L245">        }</span>
<span class="fc" id="L246">        return wikiFormatClasspath.toString();</span>
    }

	private void setupLocalTestClasspath(final StringBuilder wikiFormatClasspath) throws MojoExecutionException {
		try {
<span class="fc" id="L251">			final List&lt;String&gt; runtimeClasspathElements = this.project.getTestClasspathElements();</span>
<span class="fc" id="L252">			final ClassRealm realm = this.pluginDescriptor.getClassRealm();</span>

<span class="fc bfc" id="L254" title="All 2 branches covered.">			for(final String element : runtimeClasspathElements) {</span>
<span class="fc" id="L255">                this.fitNesseHelper.formatAndAppendClasspath(wikiFormatClasspath, element);</span>
<span class="fc" id="L256">			    final File elementFile = new File(element);</span>
<span class="fc" id="L257">			    realm.addURL(elementFile.toURI().toURL());</span>
<span class="fc" id="L258">			}</span>
<span class="nc" id="L259">		} catch (Exception e) {</span>
<span class="nc" id="L260">            throw new MojoExecutionException(&quot;Exception setting up local project test classpath&quot;, e);</span>
<span class="fc" id="L261">		}</span>
<span class="fc" id="L262">	}</span>

    private Set&lt;Artifact&gt; resolveDependencyKey(final String key) {
<span class="fc" id="L265">       	final Artifact artifact = this.pluginDescriptor.getArtifactMap().get(key);</span>
<span class="fc bfc" id="L266" title="All 2 branches covered.">       	if(artifact == null) {</span>
<span class="fc" id="L267">            getLog().warn(String.format(&quot;Lookup for artifact [%s] failed&quot;, key));</span>
<span class="fc" id="L268">            return Collections.emptySet();</span>
       	}
<span class="fc" id="L270">        return resolveArtifactTransitively(artifact);</span>
    }

    private Set&lt;Artifact&gt; resolveArtifactTransitively(final Artifact artifact) {
<span class="fc" id="L274">        final ArtifactResolutionRequest request = new ArtifactResolutionRequest()</span>
            .setArtifact( artifact )
			.setResolveRoot( true )
			.setResolveTransitively( true )
			.setRemoteRepositories( this.remoteArtifactRepositories )
			.setLocalRepository( this.localRepository );
<span class="fc" id="L280">		final ArtifactResolutionResult result = this.resolver.resolve(request);</span>
<span class="fc bfc" id="L281" title="All 2 branches covered.">        if(!result.isSuccess()) {</span>
<span class="fc bfc" id="L282" title="All 2 branches covered.">            for(Artifact missing : result.getMissingArtifacts()) {</span>
<span class="fc" id="L283">    			getLog().warn(String.format(&quot;Could not resolve artifact: [%s]&quot;, missing));</span>
<span class="fc" id="L284">        	}</span>
<span class="pc bpc" id="L285" title="1 of 4 branches missed.">        	if(result.hasExceptions() &amp;&amp; getLog().isDebugEnabled()) {</span>
<span class="fc bfc" id="L286" title="All 2 branches covered.">            	for(Exception exception : result.getExceptions()) {</span>
<span class="fc" id="L287">    		    	getLog().debug(exception);</span>
<span class="fc" id="L288">            	}</span>
        	}
        }
<span class="fc" id="L291">   		final Set&lt;Artifact&gt; dependencies = result.getArtifacts();</span>
<span class="fc" id="L292">		return dependencies;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.0.201210061924</span></div></body></html>